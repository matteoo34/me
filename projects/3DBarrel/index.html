<!--
	3D game by Keith Clark: https://keithclark.co.uk/labs/css-fps
	Drum texture link: https://keithclark.co.uk/labs/css-fps/drum2.png
-->

<!DOCTYPE html>

<html lang="en">

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="description" content="3D shadowed interactive GMod barrel">
		<meta name="author" content="Keith Clark (original), Mattéo Legagneux (remake)">
		<meta name="copyright" content="© 2021 Keith Clark (original), Mattéo Legagneux (remake). All rights reserved.">
		<style type="text/css">
			body {
				-webkit-perspective: 500px;
				perspective: 500px;
				height: 100vh;
				overflow: hidden;
				background-color: #000;
				color: #fff;
				cursor: pointer;
				user-select: none;
				text-align: center;
				font-family: Arial;
				font-size: 14px
			}
			body:active {cursor: grab}

			/* barrel element */
			.threedee {
				top: 50%;
				left: 50%;
				position: absolute;
				-webkit-backface-visibility: visible;
				backface-visibility: visible;
				-webkit-mask-image: none !important;
				mask-image: none !important;
				-webkit-transform-style: preserve-3d;
				transform-style: preserve-3d
			}

			/* toggle border checkbox */

			#boxtoggle, label {cursor: pointer}

			#boxtoggle:checked ~ .assembly .face {box-shadow: inset 0 0 0 1px #0f0}
		</style>
		<title>3D Barrel</title>
	</head>

	<body>
		<input id="boxtoggle" type="checkbox">
		<label for="boxtoggle">Show face borders</label>
		<script type="text/javascript">
			const DRUM_TEXTURE = "drum2.png",
			createFace = function(w, h, x, y, z, rx, ry, tsrc, tx, ty, br) {
				let alpha = Math.cos(rx / 1.5) * Math.cos(ry / 2),
				grad = `linear-gradient(rgba(0, 0, 0, ${alpha.toFixed(2)}), rgba(0, 0, 0, ${alpha.toFixed(2)}))`,
				transform = `translate3d(${x.toFixed(2)}px, ${y.toFixed(2)}px, ${z.toFixed(2)}px) rotateX(${rx.toFixed(2)}rad) rotateY(${ry.toFixed(2)}rad)`,
				face = document.createElement("section");
				// customize the face with the parameters
				face.className = "threedee face";
				face.style.background = `${grad}, url(${tsrc}) ${-tx.toFixed(2)}px ${ty.toFixed(2)}px`;
				face.style["-webkit-mask-image"] = `url(${tsrc})`;
				face.style.maskImage = `url(${tsrc})`;
				face.style.maskPosition = `${-tx.toFixed(2)}px ${ty.toFixed(2)}px`;
				face.style.width = `${w.toFixed(2)}px`;
				face.style.height = `${h.toFixed(2)}px`;
				face.style.marginTop = `${-(h / 2).toFixed(2)}px`;
				face.style.marginLeft = `${-(w / 2).toFixed(2)}px`;
				face.style["border-radius"] = br ? "50%" : "0px";
				face.style["-webkit-transform"] = transform;
				face.style["-ms-transform"] = transform;
				face.style.transform = transform;
				return face
			},
			createTube = function(dia, height, sides, texture) {
				let tube = document.createElement("div"),
				sideAngle = (Math.PI / sides) * 2,
				sideLen = dia * Math.tan(Math.PI / sides);
				tube.className = "threedee assembly";
				for (let c = 0; c < sides; c++) {
					let x = Math.sin(sideAngle * c) * dia / 2,
					z = Math.cos(sideAngle * c) * dia / 2,
					ry = Math.atan2(x, z);
					tube.appendChild(createFace(sideLen + 1, height, x, 0, z, 0, ry, texture, sideLen * c, 0, false))
				}
				return tube
			},
			// cube rotation values
			R = {
				x: 45, y: -22.5,
				now: {x: 0, y: 0},
				on: {x: 0, y: 0},
				old: {x: 0, y: 0}
			},
			w2 = window.innerWidth / 2, // window width / 2
			h2 = window.innerHeight / 2, // window height / 2
			// parameters
			S = 4, // sensitivity (higher number = lower sens)
			P = 2, // smooth motion (higher number = smoother motion)
			scale = 2, // barrel scale
			// mouse events
			M = {
				down: function(e) {
					R.on.x = -w2 + e.clientX;
					R.on.y = h2 + -e.clientY;
					R.old.x = R.x;
					R.old.y = R.y;
					document.addEventListener("mousemove", M.move)
				},
				move: function(e) {
					R.now.x = -w2 + e.clientX;
					R.now.y = h2 -e.clientY;
					R.x = ((R.now.x - R.on.x) / S) + R.old.x;
					R.y = ((R.now.y - R.on.y) / S) + R.old.y;
					if (R.x < -360) R.x += 360;
					if (R.x > 360) R.x -= 360;
					if (R.y < -90) R.y = -90;
					if (R.y > 90) R.y = 90;
					let transform = `scale(${scale}) rotateX(${R.y.toFixed(P)}deg) rotateY(${R.x.toFixed(P)}deg)`
					assembly.style["-webkit-transform"] = transform;
					assembly.style["-ms-transform"] = transform;
					assembly.style.transform = transform
				},
				up: function() {this.removeEventListener("mousemove", M.move)}
			};

			// create barrel
			const barrel = createTube(100, 196, 40, DRUM_TEXTURE);
			barrel.appendChild(createFace(100, 100, 0, -98, 0, Math.PI / 2, 0, DRUM_TEXTURE, 0, 100, true));
			barrel.appendChild(createFace(100, 100, 0, 98, 0, -Math.PI / 2, 0, DRUM_TEXTURE, 0, 100, true));
			document.body.appendChild(barrel);
			const assembly = document.querySelector(".assembly");
			// barrel initial rotation angle
			let transform = `scale(${scale}) rotateX(${R.y.toFixed(P)}deg) rotateY(${R.x.toFixed(P)}deg)`
			assembly.style["-webkit-transform"] = transform;
			assembly.style["-ms-transform"] = transform;
			assembly.style.transform = transform;
			// event listeners
			document.addEventListener("mousedown", M.down);
			document.addEventListener("mouseup", M.up)
		</script>
	</body>

</html>